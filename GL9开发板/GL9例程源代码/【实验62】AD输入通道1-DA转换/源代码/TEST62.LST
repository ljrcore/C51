C51 COMPILER V7.00  TEST62                                                                 09/18/2012 21:43:17 PAGE 1   


C51 COMPILER V7.00, COMPILATION OF MODULE TEST62
OBJECT MODULE PLACED IN TEST62.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE TEST62.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          ////////////////////////////////////////////////////////////////////////////
   2          //                给力者单片机开发学习系统，开发学习都给力！              //
   3          ////////////////////////////////////////////////////////////////////////////
   4          //                     学习51单片机，其实可以很简单                       //
   5          ////////////////////////////////////////////////////////////////////////////
   6          //                宁波芯动电子有限公司  www.MovingChip.com                //
   7          ////////////////////////////////////////////////////////////////////////////
   8          
   9          #include <AT89X52.h>       //调用51单片机的头文件
  10          #include <Intrins.h>       //因本例需要使用空操作，必须调用这个头文件
  11          
  12          //---------------------------------------
  13          //软件模拟IIC相关I/O设置
  14          sbit SCL=P1^7;             //PCF8591T的 SCL 引脚接于单片机的P1^7引脚上
  15          sbit SDA=P1^6;             //PCF8591T的 SDA 引脚接于单片机的P1^6引脚上
  16          //---------------------------------------
  17          
  18          //---------------------------------------
  19          //A/D转换用寄存器设置
  20          unsigned char ADbuf;       //设置8位的寄存器用来暂存A/D转换结果
  21          //---------------------------------------
  22          
  23          //---------------------------------------
  24          //名称：延时函数
  25          //适用：给力者GL9单片机开发学习系统
  26          //公司：宁波芯动电子有限公司
  27          //网址：www.MovingChip.com
  28          //日期：20120914
  29          //---------------------------------------
  30          void Delay(void)
  31          { 
  32   1           unsigned char k;      //定义一个8位寄存器用来做延时用 
  33   1           for(k=0;k<50;k++);    //延时约50微秒 
  34   1      } 
  35          
  36          //---------------------------------------
  37          //名称：生IIC启动信号函数
  38          //适用：给力者GL9单片机开发学习系统
  39          //公司：宁波芯动电子有限公司
  40          //网址：www.MovingChip.com
  41          //日期：20120914
  42          //---------------------------------------
  43          void IICstart(void)
  44          { 
  45   1           SDA=1;                //先将SDA=1，以准备在SCL=1时，将SDA=0
  46   1           SCL=1;                //时钟总线拉高 
  47   1           Delay();              //调用延时函数，略作延时 
  48   1           SDA=0;                //SCL=1时，将SDA拉低即产生启动信号 
  49   1           Delay();              //调用延时函数，略作延时 
  50   1           SCL=0;                //将SCL=0，完成启动信号操作 
  51   1           Delay();              //调用延时函数，略作延时 
  52   1      } 
  53          
  54          //---------------------------------------
  55          //名称：IIC停止信号函数
C51 COMPILER V7.00  TEST62                                                                 09/18/2012 21:43:17 PAGE 2   

  56          //适用：给力者GL9单片机开发学习系统
  57          //公司：宁波芯动电子有限公司
  58          //网址：www.MovingChip.com
  59          //日期：20120914
  60          //---------------------------------------
  61          void IICstop(void)
  62          { 
  63   1           SDA=0;                //先将SDA=0，以准备在SCL=1时，将SDA=1
  64   1           SCL=1;                //时钟总线拉高 
  65   1           Delay();              //调用延时函数，略作延时 
  66   1           SDA=1;                //SCL=1时，将SDA拉高即产生停止信号 
  67   1           Delay();              //调用延时函数，略作延时 
  68   1           SCL=0;                //将SCL=0，完成启动信号操作 
  69   1           Delay();              //调用延时函数，略作延时 
  70   1      } 
  71          
  72          //---------------------------------------
  73          //名称：向IIC总线写入1个字节函数
  74          //适用：给力者GL9单片机开发学习系统
  75          //公司：宁波芯动电子有限公司
  76          //网址：www.MovingChip.com
  77          //日期：20120914
  78          //---------------------------------------
  79          void Write1Byte(unsigned char Buf1)
  80          { 
  81   1           unsigned char k;      //1个字节要分8次写入，需要定义一个寄存器用来计数
  82   1           for(k=0;k<8;k++)      //做一个8次的循环，每次写入1位，需要写8次
  83   1           {
  84   2               if(Buf1&0x80)     //从最高位开始写 
  85   2               {
  86   3                   SDA=1;        //如果欲写入数据为1，就将数据线置1
  87   3               }
  88   2               else
  89   2               {
  90   3                   SDA=0;        //如果欲写入数据为0，就将数据线写0 
  91   3               }
  92   2               _nop_();          //略做延时
  93   2               _nop_();          //略做延时
  94   2               SCL=1;            //时钟线做一个上升沿，将一位数据写入
  95   2               Buf1=Buf1<<1;     //数据左移一位，将下次要写入的位数据移到最高位
  96   2               _nop_();          //略做延时
  97   2               SCL=0;            //将SCL=0，以准备通过上升沿将数据写入
  98   2               _nop_();          //略做延时
  99   2           }
 100   1           SDA=1;                //将SDA=1，准备读应答信号
 101   1           _nop_();              //略做延时
 102   1           SCL=1;                //将SCL=1，做个上升沿准备读应答信号
 103   1           _nop_();              //略做延时
 104   1           _nop_();              //略做延时
 105   1           SCL=0;                //将SCL=0，结束应答信号读操作
 106   1      } 
 107          
 108          //---------------------------------------
 109          //名称：从IIC总线读入1个字节函数
 110          //适用：给力者GL9单片机开发学习系统
 111          //公司：宁波芯动电子有限公司
 112          //网址：www.MovingChip.com
 113          //日期：20120914
 114          //---------------------------------------
 115          unsigned char Read1Byte(void)
 116          { 
 117   1           unsigned char k;      //1个字节要分8次读出，需要定义一个寄存器用来计数
C51 COMPILER V7.00  TEST62                                                                 09/18/2012 21:43:17 PAGE 3   

 118   1           unsigned char t=0;    //定义一个寄存器用保存读出数据
 119   1           for(k=0;k<8;k++)      //做一个8次的循环，每次读入1位，需要读8次
 120   1           {
 121   2               t=t<<1;           //数据左移一位，空出最低位以准备保存读入的一位数据
 122   2               SDA=1;            //将SDA写1准备读
 123   2               SCL=1;            //将SCL=1，做个上升沿准备读一位数据
 124   2               _nop_();          //略做延时
 125   2               _nop_();          //略做延时
 126   2               if(SDA==1)        //读一位数据，并判断 
 127   2               {
 128   3                   t=t|0x01;     //如果读入数据为1，就将接收缓冲区最低一位置1
 129   3               }
 130   2               else
 131   2               {
 132   3                   t=t&0xfe;     //如果读入数据为0，就将接收缓冲区最低一位写0
 133   3               }
 134   2               SCL=0;            //SCL恢复为0，结束一位数据读操作
 135   2               _nop_();          //略做延时
 136   2               _nop_();          //略做延时
 137   2           }
 138   1           return t;             //将读入的一个字节返回
 139   1      } 
 140          
 141          //---------------------------------------
 142          //名称：软件模拟IIC向PCF8591指定地址写一个字节函数
 143          //适用：给力者GL9单片机开发学习系统
 144          //公司：宁波芯动电子有限公司
 145          //网址：www.MovingChip.com
 146          //日期：20120914
 147          //---------------------------------------
 148          void WritePCF8591(unsigned char Databuf)
 149          {                          //直接调用本函数即可启动PCF8591的D/A转换
 150   1          IICstart();            //IIC启动信号
 151   1      
 152   1          Write1Byte(0x90);      //发送PCF8591的器件地址和写信号
 153   1      
 154   1          Write1Byte(0x40);      //发送器件子地址
 155   1      
 156   1          Write1Byte(Databuf);   //发送数据
 157   1      
 158   1          IICstop();             //产生IIC停止信号
 159   1      }
 160          
 161          //---------------------------------------
 162          //名称：软件模拟IIC从PCF8563指定地址读一个字节函数
 163          //适用：给力者GL9单片机开发学习系统
 164          //公司：宁波芯动电子有限公司
 165          //网址：www.MovingChip.com
 166          //日期：20120914
 167          //---------------------------------------
 168          unsigned ReadPCF8591(unsigned char Ch)
 169          {                          //直接调用本函数即可从PCF8591的Ch通道读出数据返回
 170   1          unsigned char buf;     //定义一个寄存器用来暂存读出的数据
 171   1          IICstart();            //IIC启动信号
 172   1      
 173   1          Write1Byte(0x90);      //发送PCF8591的器件地址和写信号
 174   1      
 175   1          Write1Byte(0x40|Ch);   //发送器件通道参数Ch=0-3
 176   1      
 177   1          IICstart();            //IIC启动信号
 178   1      
 179   1          Write1Byte(0x91);      //发送PCF8591的器件地址和读信号
C51 COMPILER V7.00  TEST62                                                                 09/18/2012 21:43:17 PAGE 4   

 180   1      
 181   1          buf=Read1Byte();//读一个字节数据
 182   1      
 183   1          IICstop();             //产生IIC停止信号
 184   1      
 185   1          return(buf);           //将读出数据返回
 186   1      }
 187          
 188          //---------------------------------------
 189          //名称: 主函数
 190          //适用：给力者GL9单片机开发学习系统
 191          //公司：宁波芯动电子有限公司
 192          //网址：www.MovingChip.com
 193          //日期：20120914
 194          //---------------------------------------
 195          void main(void)            //主函数,单片机开机后就是从这个函数开始运行
 196          {
 197   1      
 198   1          while(1)               //死循环,单片机初始化后,将一直运行这个死循环
 199   1          {
 200   2              ADbuf=ReadPCF8591(0);     //将AIN0通道A/D转换结果暂存在ADbuf
 201   2              WritePCF8591(ADbuf);      //利用ADbuf进行D/A转换
 202   2      
 203   2          }
 204   1      }
 205          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    178    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
