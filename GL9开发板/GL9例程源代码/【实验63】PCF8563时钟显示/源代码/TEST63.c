////////////////////////////////////////////////////////////////////////////
//                ߵƬѧϰϵͳѧϰ              //
////////////////////////////////////////////////////////////////////////////
//                     ѧϰ51ƬʵԺܼ                       //
////////////////////////////////////////////////////////////////////////////
//                о޹˾  www.MovingChip.com                //
////////////////////////////////////////////////////////////////////////////

#include <AT89X52.h>       //51Ƭͷļ
#include <Intrins.h>       //Ҫʹÿղͷļ

//---------------------------------------
//1602ҺI/O
sbit E=P2^3;               //1602ҺEŽP2.3
sbit RW=P2^4;              //1602ҺRWŽP2.4
sbit RS=P2^5;              //1602ҺRSŽP2.5
//---------------------------------------

//---------------------------------------
//ģIICI/O
sbit SCL=P1^1;             //PCF8563T SCL ŽڵƬP1^1
sbit SDA=P1^0;             //PCF8563T SDA ŽڵƬP1^0
//---------------------------------------


unsigned char j;      
//---------------------------------------

//---------------------------------------
//1602ҺĴ
unsigned char DISbuf;     //8λunsigend charͼĴݴ1602Ҫʾ
//---------------------------------------

//---------------------------------------
//ƣIICźź
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void IICstart(void)
{ 
     SDA=1;                //ȽSDA=1׼SCL=1ʱSDA=0
     SCL=1;                //ʱ 
     _nop_();          		//ʱ
     _nop_();          		//ʱ
     SDA=0;                //SCL=1ʱSDAͼź 
     _nop_();          		//ʱ
     _nop_();          		//ʱ
     SCL=0;                //SCL=0źŲ      
} 

//---------------------------------------
//ƣIICֹͣźź
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void IICstop(void)
{ 
     SDA=0;                //ȽSDA=0׼SCL=1ʱSDA=1
     SCL=1;                //ʱ 
     _nop_();          		//ʱ
     _nop_();          		//ʱ 
     SDA=1;                //SCL=1ʱSDA߼ֹͣź 
     _nop_();          		//ʱ
     _nop_();          		//ʱ
     SCL=0;                //SCL=0źŲ      
} 

//---------------------------------------
//ƣIICд1ֽں
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void Write1Byte(unsigned char Buf1)
{ 
     unsigned char k;      //1ֽҪ8д룬ҪһĴ
     for(k=0;k<8;k++)      //һ8εѭÿд1λҪд8
     {
         if(Buf1&0x80)     //λʼд 
         {
             SDA=1;        //дΪ1ͽ1
         }
         else
         {
             SDA=0;        //дΪ0ͽд0 
         }
         _nop_();          //ʱ
         _nop_();          //ʱ
         SCL=1;            //ʱһأһλд
         Buf1=Buf1<<1;     //һλ´ҪдλƵλ
         _nop_();          //ʱ
         SCL=0;            //SCL=0׼ͨؽд
         _nop_();          //ʱ
     }
     SDA=1;                //SDA=1׼Ӧź
     _nop_();              //ʱ
     SCL=1;                //SCL=1׼Ӧź
     _nop_();              //ʱ
     _nop_();              //ʱ
     SCL=0;                //SCL=0ӦźŶ
} 

//---------------------------------------
//ƣIIC߶1ֽں
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
unsigned char Read1Byte(void)
{ 
     unsigned char k;      //1ֽҪ8ζҪһĴ
     unsigned char t=0;    //һĴñ
     for(k=0;k<8;k++)      //һ8εѭÿζ1λҪ8
     {
         t=t<<1;           //һλճλ׼һλ
         SDA=1;            //SDAд1׼
         SCL=1;            //SCL=1׼һλ
         _nop_();          //ʱ
         _nop_();          //ʱ
         if(SDA==1)        //һλݣж 
         {
             t=t|0x01;     //Ϊ1ͽջһλ1
         }
         else
         {
             t=t&0xfe;     //Ϊ0ͽջһλд0
         }
         SCL=0;            //SCLָΪ0һλݶ
         _nop_();          //ʱ
         _nop_();          //ʱ
     }
     return t;             //һֽڷ
} 

//---------------------------------------
//ƣģIICPCF8563ַָдһֽں
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void WritePCF8563(unsigned char Address,unsigned char Databuf)
{                          //ֱӵñɶPCF8563AddressַдDatabuf
    IICstart();            //IICź

    Write1Byte(0xA2);      //PCF8563ַдź

    Write1Byte(Address);   //͵ַ

    Write1Byte(Databuf);   //

    IICstop();             //IICֹͣź
}

//---------------------------------------
//ƣģIICPCF8563ַָһֽں
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
unsigned ReadPCF8563(unsigned char Address)
{                          //ֱӵñɴPCF8563Addressַݷ
    unsigned char buf;     //һĴݴ
    IICstart();            //IICź

    Write1Byte(0xA2);      //PCF8563ַдź

    Write1Byte(Address);   //͵ַ

    IICstart();            //IICź

    Write1Byte(0xA3);      //PCF8563ַͶź

    buf=Read1Byte();//һֽ

    IICstop();             //IICֹͣź

    return(buf);           //ݷ
}

//---------------------------------------
//ƣ1602Һʱ
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void Delay1602(unsigned int t)
{ 
     unsigned int k;      //һ16λĴʱ 
     for(k=0;k<t;k++);    //ʱ 
} 

//---------------------------------------
//ƣ1602Һæ⺯
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void LCD1602_busy(void)
{ 
     P0_7=1;              //P0.71Ϊ״̬׼ 
     RS=0;                //RS=0RW=1E=1ʱæźDB7P0.7
     RW=1;                //RS=0RW=1E=1ʱæźDB7P0.7
     E=1;                 //RS=0RW=1E=1ʱæźDB7P0.7
     while(P0_7==1);      //P0.71ʾ1602ҺæҪȴ
     E=0;                 //Ժ󣬻ָEĵƽ
} 

//---------------------------------------
//ƣ1600д
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void LCD1602_Write_com(unsigned char combuf)
{ 
     RS=0;                //ѡָĴ
     RW=0;                //ѡд״̬
     P0=combuf;           //ͨP0DB
     E=1;                 //Eߵƽд1602Һ
     E=0;                 //дԺ󣬻ָEĵƽ
} 

//---------------------------------------
//ƣ1602д(æ)
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void LCD1602_Write_com_busy(unsigned char combuf)
{ 
     LCD1602_busy();            //æ⺯
     LCD1602_Write_com(combuf); //æ⺯
} 

//---------------------------------------
//ƣ1602дݺ(æ)
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void LCD1602_Write_data_busy(unsigned char databuf)
{ 
     LCD1602_busy();      //æ⺯
     RS=1;                //ѡݼĴ
     RW=0;                //ѡд״̬
     P0=databuf;          //ͨP0DB
     E=1;                 //Eߵƽд1602Һ
     E=0;                 //дԺ󣬻ָEĵƽ
} 

//---------------------------------------
//ƣ1602Һʾַд
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void LCD1602_Write_address(unsigned char x,unsigned char y)
{ 
     x&=0x0f;             //еַ0-15
     y&=0x01;             //еַ0-1
     if(y==0)             //ǵһ
         LCD1602_Write_com_busy(x|0x80);        //еַд
     else                 //ǵڶ
         LCD1602_Write_com_busy((x+0x40)|0x80); //еַд
} 

//---------------------------------------
//ƣ1602Һʼ
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void LCD1602_init(void)
{ 
     Delay1602(1500);               //ʱ
     LCD1602_Write_com(0x38);       //8λߣʾģʽ5*7ʾ
     Delay1602(500);                //ʱ
     LCD1602_Write_com(0x38);       //8λߣʾģʽ5*7ʾ
     Delay1602(500);                //ʱ
     LCD1602_Write_com(0x38);       //8λߣʾģʽ5*7ʾ
     LCD1602_Write_com_busy(0x38);  //8λߣʾģʽ5*7ʾ
     LCD1602_Write_com_busy(0x08);  //ʾܹأ޹
     LCD1602_Write_com_busy(0x01);  //
     LCD1602_Write_com_busy(0x06);  //дµݺ󣬹ƣʾƶ
     LCD1602_Write_com_busy(0x0C);  //ʾܿ޹
} 

//---------------------------------------
//ƣ1602Һַָʾ
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void LCD1602_Disp(unsigned char x,unsigned char y,unsigned char buf)
{ 
     LCD1602_Write_address(x,y);    //ȽַϢд
     LCD1602_Write_data_busy(buf);  //дҪʾ
} 

//---------------------------------------
//: 
//ãGL9Ƭѧϰϵͳ
//˾о޹˾
//ַwww.MovingChip.com
//ڣ20140215
//---------------------------------------
void main(void)            //,ƬǴʼ
{

    LCD1602_init();        //1602Һʼ

    //***ʼʱоƬĲΪ1293200307***
    WritePCF8563(0x00,0x00); //PCF8563
    WritePCF8563(0x02,0x07); //ʼΪ07
    WritePCF8563(0x03,0x03); //÷ӳʼΪ03
    WritePCF8563(0x04,0x20); //СʱʼΪ20
    WritePCF8563(0x05,0x03); //ճʼΪ03
    WritePCF8563(0x06,0x01); //ڳʼΪ01
    WritePCF8563(0x07,0x09); //³ʼΪ09
    WritePCF8563(0x08,0x12); //ʼΪ12
    //***************************
    while(1)               //ѭ,Ƭʼ,һֱѭ
    {
        DISbuf=ReadPCF8563(0x08); // 
    
    //***1602Һʾ0-0XFF***
        j=DISbuf>>4;                //Ҫʾݵĸ4λƵ4λ
		j&=0x01;
        j+='0';                 	//0-90ΪƫƼ        
        LCD1602_Disp(0,0,j);        //ڵ1еĵ3ʾ4λʮ
        j=DISbuf&0x0F;              //Ҫʾݵĸ4λε4λ
        j+='0';                 	//0-90ΪƫƼ        
        LCD1602_Disp(1,0,j);        //ڵ1еĵ4ʾ4λʮ
    //***********************
		LCD1602_Disp(2,0,'.');        //ʾ
		DISbuf=ReadPCF8563(0x07); 	//²
		//***1602Һʾ0-0XFF***
        j=DISbuf>>4;                //Ҫʾݵĸ4λƵ4λ
		j&=0x01;
        j+='0';                 	//0-90ΪƫƼ        
        LCD1602_Disp(3,0,j);        //ڵ1еĵ3ʾ4λʮ
        j=DISbuf&0x0F;              //Ҫʾݵĸ4λε4λ
        j+='0';                 	//0-90ΪƫƼ        
        LCD1602_Disp(4,0,j);        //ڵ1еĵ4ʾ4λʮ
    //***********************
		LCD1602_Disp(5,0,'.');        //ʾ
        DISbuf=ReadPCF8563(0x05); 	//ղ
		//***1602Һʾ0-0XFF***
        j=DISbuf>>4;                //Ҫʾݵĸ4λƵ4λ
		j&=0x03;
        j+='0';                 	//0-90ΪƫƼ       
        LCD1602_Disp(6,0,j);        //ڵ1еĵ3ʾ4λʮ
        j=DISbuf&0x0F;              //Ҫʾݵĸ4λε4λ
        j+='0';                 	//0-90ΪƫƼ        
        LCD1602_Disp(7,0,j);        //ڵ1еĵ4ʾ4λʮ
    //***********************
        DISbuf=ReadPCF8563(0x04); 	//Сʱ
	//***1602Һʾ0-0XFF***
        j=DISbuf>>4;                //Ҫʾݵĸ4λƵ4λ
		j&=0x03;
        j+='0';                 	//0-90ΪƫƼ        
        LCD1602_Disp(0,1,j);        //ڵ1еĵ3ʾ4λʮ
        j=DISbuf&0x0F;              //Ҫʾݵĸ4λε4λ
        j+='0';                 	//0-90ΪƫƼ        
        LCD1602_Disp(1,1,j);        //ڵ1еĵ4ʾ4λʮ
    //***********************
		LCD1602_Disp(2,1,':');        //ʾ':'
        DISbuf=ReadPCF8563(0x03); 	//Ӳ
	//***1602Һʾ0-0XFF***
        j=DISbuf>>4;                //Ҫʾݵĸ4λƵ4λ
		j&=0x07;
        j+='0';                 	//0-90ΪƫƼ        
        LCD1602_Disp(3,1,j);        //ڵ1еĵ3ʾ4λʮ
        j=DISbuf&0x0F;              //Ҫʾݵĸ4λε4λ
        j+='0';                 	//0-90ΪƫƼ          
        LCD1602_Disp(4,1,j);        //ڵ1еĵ4ʾ4λʮ
    //***********************
		LCD1602_Disp(5,1,':');        //ʾ':'
        DISbuf=ReadPCF8563(0x02); 	//
		//***1602Һʾ0-0XFF***
        j=DISbuf>>4;                //Ҫʾݵĸ4λƵ4λ
		j&=0x07;
        j+='0';                     //0-90ΪƫƼ        
        LCD1602_Disp(6,1,j);        //ڵ1еĵ3ʾ4λʮ
        j=DISbuf&0x0F;              //Ҫʾݵĸ4λε4λ
        j+='0';                     //0-90ΪƫƼ          
        LCD1602_Disp(7,1,j);        //ڵ1еĵ4ʾ4λʮ
    //***********************
    }
}


