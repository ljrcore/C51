C51 COMPILER V7.00  TEST59                                                                 09/18/2012 21:40:38 PAGE 1   


C51 COMPILER V7.00, COMPILATION OF MODULE TEST59
OBJECT MODULE PLACED IN TEST59.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE TEST59.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          ////////////////////////////////////////////////////////////////////////////
   2          //                给力者单片机开发学习系统，开发学习都给力！              //
   3          ////////////////////////////////////////////////////////////////////////////
   4          //                     学习51单片机，其实可以很简单                       //
   5          ////////////////////////////////////////////////////////////////////////////
   6          //                宁波芯动电子有限公司  www.MovingChip.com                //
   7          ////////////////////////////////////////////////////////////////////////////
   8          
   9          #include <AT89X52.h>       //调用51单片机的头文件
  10          #include <Intrins.h>       //因本例需要使用空操作，必须调用这个头文件
  11          
  12          unsigned char code tab[27]={
  13          0,10,20,30,40,50,60,70,80,90,100,110,120,130,140,
  14          150,160,170,180,190,200,210,220,230,240,250,255};
  15          
  16          //---------------------------------------
  17          //软件模拟IIC相关I/O设置
  18          sbit SCL=P1^7;             //PCF8591T的 SCL 引脚接于单片机的P1^7引脚上
  19          sbit SDA=P1^6;             //PCF8591T的 SDA 引脚接于单片机的P1^6引脚上
  20          //---------------------------------------
  21          
  22          //---------------------------------------
  23          //A/D转换用寄存器设置
  24          unsigned char ADbuf;       //设置8位的寄存器用来暂存A/D转换结果
  25          //---------------------------------------
  26          
  27          //---------------------------------------
  28          //名称：生IIC启动信号函数
  29          //适用：给力者GL9单片机开发学习系统
  30          //公司：宁波芯动电子有限公司
  31          //网址：www.MovingChip.com
  32          //日期：20120914
  33          //---------------------------------------
  34          void IICstart(void)
  35          { 
  36   1           SDA=1;                //先将SDA=1，以准备在SCL=1时，将SDA=0
  37   1           SCL=1;                //时钟总线拉高 
  38   1           _nop_();                   //略做延时
  39   1           _nop_();                   //略做延时
  40   1           SDA=0;                //SCL=1时，将SDA拉低即产生启动信号 
  41   1           _nop_();                   //略做延时
  42   1           _nop_();                   //略做延时
  43   1           SCL=0;                //将SCL=0，完成启动信号操作      
  44   1      } 
  45          
  46          //---------------------------------------
  47          //名称：IIC停止信号函数
  48          //适用：给力者GL9单片机开发学习系统
  49          //公司：宁波芯动电子有限公司
  50          //网址：www.MovingChip.com
  51          //日期：20120914
  52          //---------------------------------------
  53          void IICstop(void)
  54          { 
  55   1           SDA=0;                //先将SDA=0，以准备在SCL=1时，将SDA=1
C51 COMPILER V7.00  TEST59                                                                 09/18/2012 21:40:38 PAGE 2   

  56   1           SCL=1;                //时钟总线拉高 
  57   1           _nop_();                   //略做延时
  58   1           _nop_();                   //略做延时
  59   1           SDA=1;                //SCL=1时，将SDA拉高即产生停止信号 
  60   1           _nop_();                   //略做延时
  61   1           _nop_();                   //略做延时
  62   1           SCL=0;                //将SCL=0，完成启动信号操作      
  63   1      } 
  64          
  65          //---------------------------------------
  66          //名称：向IIC总线写入1个字节函数
  67          //适用：给力者GL9单片机开发学习系统
  68          //公司：宁波芯动电子有限公司
  69          //网址：www.MovingChip.com
  70          //日期：20120914
  71          //---------------------------------------
  72          void Write1Byte(unsigned char Buf1)
  73          { 
  74   1           unsigned char k;      //1个字节要分8次写入，需要定义一个寄存器用来计数
  75   1           for(k=0;k<8;k++)      //做一个8次的循环，每次写入1位，需要写8次
  76   1           {
  77   2               if(Buf1&0x80)     //从最高位开始写 
  78   2               {
  79   3                   SDA=1;        //如果欲写入数据为1，就将数据线置1
  80   3               }
  81   2               else
  82   2               {
  83   3                   SDA=0;        //如果欲写入数据为0，就将数据线写0 
  84   3               }
  85   2               _nop_();          //略做延时
  86   2               _nop_();          //略做延时
  87   2               SCL=1;            //时钟线做一个上升沿，将一位数据写入
  88   2               Buf1=Buf1<<1;     //数据左移一位，将下次要写入的位数据移到最高位
  89   2               _nop_();          //略做延时
  90   2               SCL=0;            //将SCL=0，以准备通过上升沿将数据写入
  91   2               _nop_();          //略做延时
  92   2           }
  93   1           SDA=1;                //将SDA=1，准备读应答信号
  94   1           _nop_();              //略做延时
  95   1           SCL=1;                //将SCL=1，做个上升沿准备读应答信号
  96   1           _nop_();              //略做延时
  97   1           _nop_();              //略做延时
  98   1           SCL=0;                //将SCL=0，结束应答信号读操作
  99   1      } 
 100          
 101          //---------------------------------------
 102          //名称：从IIC总线读入1个字节函数
 103          //适用：给力者GL9单片机开发学习系统
 104          //公司：宁波芯动电子有限公司
 105          //网址：www.MovingChip.com
 106          //日期：20120914
 107          //---------------------------------------
 108          unsigned char Read1Byte(void)
 109          { 
 110   1           unsigned char k;      //1个字节要分8次读出，需要定义一个寄存器用来计数
 111   1           unsigned char t=0;    //定义一个寄存器用保存读出数据
 112   1           for(k=0;k<8;k++)      //做一个8次的循环，每次读入1位，需要读8次
 113   1           {
 114   2               t=t<<1;           //数据左移一位，空出最低位以准备保存读入的一位数据
 115   2               SDA=1;            //将SDA写1准备读
 116   2               SCL=1;            //将SCL=1，做个上升沿准备读一位数据
 117   2               _nop_();          //略做延时
C51 COMPILER V7.00  TEST59                                                                 09/18/2012 21:40:38 PAGE 3   

 118   2               _nop_();          //略做延时
 119   2               if(SDA==1)        //读一位数据，并判断 
 120   2               {
 121   3                   t=t|0x01;     //如果读入数据为1，就将接收缓冲区最低一位置1
 122   3               }
 123   2               else
 124   2               {
 125   3                   t=t&0xfe;     //如果读入数据为0，就将接收缓冲区最低一位写0
 126   3               }
 127   2               SCL=0;            //SCL恢复为0，结束一位数据读操作
 128   2               _nop_();          //略做延时
 129   2               _nop_();          //略做延时
 130   2           }
 131   1           return t;             //将读入的一个字节返回
 132   1      } 
 133          
 134          //---------------------------------------
 135          //名称：软件模拟IIC向PCF8591指定地址写一个字节函数
 136          //适用：给力者GL9单片机开发学习系统
 137          //公司：宁波芯动电子有限公司
 138          //网址：www.MovingChip.com
 139          //日期：20120914
 140          //---------------------------------------
 141          void WritePCF8591(unsigned char Databuf)
 142          {                          //直接调用本函数即可启动PCF8591的D/A转换
 143   1          IICstart();            //IIC启动信号
 144   1      
 145   1          Write1Byte(0x90);      //发送PCF8591的器件地址和写信号
 146   1      
 147   1          Write1Byte(0x40);      //发送器件子地址
 148   1      
 149   1          Write1Byte(Databuf);   //发送数据
 150   1      
 151   1          IICstop();             //产生IIC停止信号
 152   1      }
 153          
 154          //---------------------------------------
 155          //名称：软件模拟IIC从PCF8563指定地址读一个字节函数
 156          //适用：给力者GL9单片机开发学习系统
 157          //公司：宁波芯动电子有限公司
 158          //网址：www.MovingChip.com
 159          //日期：20120914
 160          //---------------------------------------
 161          unsigned ReadPCF8591(unsigned char Ch)
 162          {                          //直接调用本函数即可从PCF8591的Ch通道读出数据返回
 163   1          unsigned char buf;     //定义一个寄存器用来暂存读出的数据
 164   1          IICstart();            //IIC启动信号
 165   1      
 166   1          Write1Byte(0x90);      //发送PCF8591的器件地址和写信号
 167   1      
 168   1          Write1Byte(0x40|Ch);   //发送器件通道参数Ch=0-3
 169   1      
 170   1          IICstart();            //IIC启动信号
 171   1      
 172   1          Write1Byte(0x91);      //发送PCF8591的器件地址和读信号
 173   1      
 174   1          buf=Read1Byte();//读一个字节数据
 175   1      
 176   1          IICstop();             //产生IIC停止信号
 177   1      
 178   1          return(buf);           //将读出数据返回
 179   1      }
C51 COMPILER V7.00  TEST59                                                                 09/18/2012 21:40:38 PAGE 4   

 180          
 181          //---------------------------------------
 182          //名称: 主函数
 183          //适用：给力者GL9单片机开发学习系统
 184          //公司：宁波芯动电子有限公司
 185          //网址：www.MovingChip.com
 186          //日期：20120914
 187          //---------------------------------------
 188          void main(void)            //主函数,单片机开机后就是从这个函数开始运行
 189          {
 190   1              unsigned char i;  
 191   1          unsigned int  l;
 192   1          while(1)               //死循环,单片机初始化后,将一直运行这个死循环
 193   1          {
 194   2                      for(i=0;i<27;i++)
 195   2                  {
 196   3                      WritePCF8591(tab[i]);        //利用输入参数进行D/A转换
 197   3                              for(l=0;l<20000;l++);
 198   3                      }
 199   2          }
 200   1      }
 201          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    178    ----
   CONSTANT SIZE    =     27    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
