C51 COMPILER V7.00  LD788BS                                                                10/16/2012 12:34:50 PAGE 1   


C51 COMPILER V7.00, COMPILATION OF MODULE LD788BS
OBJECT MODULE PLACED IN LD788BS.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE LD788BS.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          ////////////////////////////////////////////////////////////////////////////
   2          //                ¸øÁ¦Õßµ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³£¬¿ª·¢Ñ§Ï°¶¼¸øÁ¦£¡              //
   3          ////////////////////////////////////////////////////////////////////////////
   4          //                     Ñ§Ï°51µ¥Æ¬»ú£¬ÆäÊµ¿ÉÒÔºÜ¼òµ¥                       //
   5          ////////////////////////////////////////////////////////////////////////////
   6          //                Äþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾  www.MovingChip.com                //
   7          ////////////////////////////////////////////////////////////////////////////
   8          #include <AT89X52.h>       //µ÷ÓÃ51µ¥Æ¬»úµÄÍ·ÎÄ¼þ
   9          #include <Intrins.h>       //Òò±¾ÀýÐèÒªÊ¹ÓÃ¿Õ²Ù×÷£¬±ØÐëµ÷ÓÃÕâ¸öÍ·ÎÄ¼þ
  10          
  11          sfr      WDT_CONTR=0xe1;
  12          //---------------------------------------
  13          //W25Q16Ïà¹ØI/OÉèÖÃ
  14          sbit CS          = P3^6;        //Ñ¡Í¨  
  15          sbit DIO         = P3^5;   //µ¥Æ¬»úÊä³ö
  16          sbit DO          = P3^7;        //FLASHÊä³ö
  17          sbit SCLK        = P3^4;        //Ê±ÖÓ
  18          //---------------------------------------
  19          //---------------------------------------
  20          //LEDµãÕóÆÁÏà¹ØI/OÉèÖÃ
  21          sbit U15E3=P1^3;           //LEDµãÕóÆÁµ¥ÔªµÄU15(74HC138)µÄÊ¹ÄÜ¶ËE3½Å½ÓÔÚP1.3¿ÚÉÏ
  22          sbit U14E3=P1^4;           //LEDµãÕóÆÁµ¥ÔªµÄU14(74HC138)µÄÊ¹ÄÜ¶ËE3½Å½ÓÔÚP1.4¿ÚÉÏ
  23          //---------------------------------------
  24          
  25          //---------------------------------------
  26          //LEDµãÕóÆÁ¼Ä´æÆ÷ÉèÖÃ
  27          unsigned char m=15;        //ÉèÖÃ8Î»µÄunsigend charÐÍ¼Ä´æÆ÷ÓÃÀ´×öºº×ÖÏÔÊ¾µÄË÷Òý
  28          unsigned char n;           //ÉèÖÃ8Î»µÄunsigend charÐÍ¼Ä´æÆ÷ÓÃÀ´×öÑÓÊ±ÓÃ
  29          unsigned char w;           //ÉèÖÃ8Î»µÄunsigend charÐÍ¼Ä´æÆ÷ÓÃÀ´×öÑÓÊ±ÓÃ
  30          unsigned int  v;           //ÉèÖÃ8Î»µÄunsigend charÐÍ¼Ä´æÆ÷ÓÃÀ´×öÒÆ¶¯Ë÷Òý
  31          unsigned char  xdata hanzibuf1[512];
  32          unsigned char  xdata hanzibuf2[512];
  33          unsigned char L;
  34          //---------------------------------------
  35          //***************************************************************
  36          #define W25X_ReadStatus       0x05              //¶Á×´Ì¬¼Ä´æÆ÷
  37          #define W25X_WriteStatus      0x01              //Ð´×´Ì¬¼Ä´æÆ÷
  38          #define W25X_ReadDATA8        0x03              //ÆÕ¶Á_Êý¾Ý
  39          #define W25X_FastRead         0x0B              //¿ì¶Á_Êý¾Ý
  40          #define W25X_DualOutput       0x3B              //¿ì¶Á_Ë«Êä³ö
  41          #define W25X_Write            0x02              //Ð´_Êý¾Ý_0~255¸ö×Ö½Ú
  42          #define W25X_S_Erase          0x20              //ÉÈÇø²Á³ý4KB
  43          #define W25X_B_Erase          0xD8              //¿éÇø²Á³ý64KB
  44          #define W25X_C_Erase          0xC7              //ÕûÆ¬¸ñÊ½»¯
  45          #define W25X_PowerDown        0xB9              //´ý»ú
  46          #define W25X_PowerON_ID       0xAB              //¿ª»ú»òÊÇ¶ÁID
  47          #define W25X_JEDEC_ID         0x9F              //Ê®ÁùÎ»µÄJEDEC_ID
  48          #define W25X_WriteEnable      0x06              //Ð´³äÐí
  49          #define W25X_WriteDisable     0x04              //Ð´½ûÖ¹
  50          
  51          unsigned char ComBuf[21];//´®¿ÚÍ¨Ñ¶Êý¾Ý»º´æ£¬·¢ËÍºÍ½ÓÊÕ¶¼Ê¹ÓÃ
  52          unsigned int  nTimeOut;//³¬Ê±¼ÆÊý
  53          unsigned char Buf[16];
  54          
  55          long neima(unsigned char qh,wh)
C51 COMPILER V7.00  LD788BS                                                                10/16/2012 12:34:50 PAGE 2   

  56          {
  57   1         unsigned long vb;    
  58   1              qh=qh-0xa0;   //µÃµ½ÇøºÅ
  59   1              wh=wh-0xa0;   //µÃµ½ÇøºÅ        
  60   1              vb=(94*(qh-1)+(wh-1));
  61   1              vb=vb<<5;               
  62   1              return vb;
  63   1      } 
  64          
  65          //---------------------------------------
  66          //Ãû³Æ: SPIÐ´ÈëÒ»¸ö×Ö½Úº¯Êý
  67          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
  68          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
  69          //ÍøÖ·£ºwww.MovingChip.com
  70          //ÈÕÆÚ£º20120916
  71          //---------------------------------------
  72          void Send_OneByte(unsigned char DATA8) //´ÓSPI·¢8Î»Êý
  73          {                                                                   //ÉÏÉýÑØÐ´Èë
  74   1         unsigned char x;      
  75   1         for (x=0;x<8;x++)
  76   1         { 
  77   2                      SCLK=0;
  78   2                      if(DATA8&0x80)DIO=1;
  79   2                      else DIO=0;
  80   2                      SCLK=1;
  81   2                      DATA8=DATA8<<1;
  82   2              }     
  83   1      } 
  84          //---------------------------------------
  85          //Ãû³Æ: SPI¶Á³öÒ»¸ö×Ö½Úº¯Êý
  86          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
  87          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
  88          //ÍøÖ·£ºwww.MovingChip.com
  89          //ÈÕÆÚ£º20120916
  90          //---------------------------------------
  91          unsigned char Read_OneByte(void)     //´ÓSPIÊÕ8Î»Êý
  92             {                                                     //ÏÂ½µÑØÊä³ö
  93   1         unsigned char DATA8;
  94   1         unsigned char x;
  95   1         SCLK=1;
  96   1         DATA8=0x00;
  97   1         for (x=0;x<8;x++)
  98   1         { 
  99   2                      _nop_();
 100   2                      SCLK=0;
 101   2                      DATA8=DATA8<<1;
 102   2                      if(DO)DATA8=DATA8|0x01;
 103   2                      SCLK=1;  
 104   2              }
 105   1         return (DATA8);   
 106   1      }
 107          //---------------------------------------
 108          //Ãû³Æ: Ð´ÔÊÐíº¯Êý
 109          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 110          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 111          //ÍøÖ·£ºwww.MovingChip.com
 112          //ÈÕÆÚ£º20120916
 113          //---------------------------------------
 114          void WriteEnable  (void)
 115          {
 116   1         SCLK=1;
 117   1         CS=0;
C51 COMPILER V7.00  LD788BS                                                                10/16/2012 12:34:50 PAGE 3   

 118   1         Send_OneByte(W25X_WriteEnable);  
 119   1         CS=1;
 120   1         SCLK=1;
 121   1      }
 122          //---------------------------------------
 123          //Ãû³Æ: Ð´½ûÖ¹º¯Êý
 124          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 125          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 126          //ÍøÖ·£ºwww.MovingChip.com
 127          //ÈÕÆÚ£º20120916
 128          //---------------------------------------
 129          void WriteDisable (void)
 130          {
 131   1         SCLK=1;
 132   1         CS=0;
 133   1         Send_OneByte(W25X_WriteDisable);  
 134   1         CS=1;
 135   1         SCLK=1;
 136   1      }
 137          //---------------------------------------
 138          //Ãû³Æ: ÅÐ¶ÏW25Q16Ã¦º¯Êý
 139          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 140          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 141          //ÍøÖ·£ºwww.MovingChip.com
 142          //ÈÕÆÚ£º20120916
 143          //---------------------------------------
 144          unsigned char W25X_BUSY_OrNot (void)    //ÔÚ¶ÁºÍÐ´Ö®Ç°µÃÏÈÅÐ¶ÏFLASHÊÇ·ñBUSY
 145          {                                                                                       //BUSYµÄÔ­ÒòÊÇ²Á³ý£¬»òÊÇÁ¬Ðø¶ÁÐ´
 146   1         unsigned char k;                                     //Èç¹ûÃ»ÓÐÒÔÉÏ·½Ê½£¬²»±ØÅÐ¶¨¿ÉÒÔÐ´¶Á  
 147   1         SCLK=1;
 148   1         _nop_();
 149   1         CS=0;
 150   1         Send_OneByte(W25X_ReadStatus);   //¶Á×´Ì¬¼Ä´æÆ÷
 151   1         k=Read_OneByte();                                    //¶ÁÒ»¸ö×Ö½Ú
 152   1         k=k&0x01;
 153   1         CS=1;
 154   1              _nop_();
 155   1         SCLK=1;
 156   1         return k;                         //·µ»Ø1±íÊ¾Ã¦£¬·µ»Ø0±íÊ¾²»Ã¦   
 157   1      }       
 158          //---------------------------------------
 159          //Ãû³Æ: ÍùFLASH´æ´¢Æ÷ÖÐÐ´Êý¾Ýº¯Êý
 160          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 161          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 162          //ÍøÖ·£ºwww.MovingChip.com
 163          //ÈÕÆÚ£º20120916
 164          //---------------------------------------
 165          void W25X_Flash_Byte_Write(unsigned char AddreH,unsigned char AddreM,unsigned char AddreL)    
 166          {                                                                
 167   1         unsigned char J;   //¼Æ×Ö½ÚÊý
 168   1         while(W25X_BUSY_OrNot ());  //ÅÐBUSY µÈµ½FlashÏÐ²ÅÄÜ²Ù×÷
 169   1         WriteEnable();   //Ð´ÔÊÐí
 170   1         SCLK=1;   
 171   1              _nop_();
 172   1              _nop_();
 173   1         CS=0;
 174   1         Send_OneByte(W25X_Write);  //ÃüÁî
 175   1         Send_OneByte(AddreH);
 176   1         Send_OneByte(AddreM);
 177   1         Send_OneByte(AddreL);
 178   1         for (J=0;J<16;J++)
 179   1         {
C51 COMPILER V7.00  LD788BS                                                                10/16/2012 12:34:50 PAGE 4   

 180   2              Send_OneByte(Buf[J]); //Ð´×Ö½Ú
 181   2              }
 182   1         CS=1;
 183   1         _nop_();
 184   1              _nop_();
 185   1         SCLK=1;
 186   1         for(J=0;J<200;J++) //ÑÓÊ±Ò»µãµã
 187   1         {
 188   2           _nop_();
 189   2                _nop_();
 190   2         }
 191   1      }       
 192          //---------------------------------------
 193          //Ãû³Æ: ´ÓFLASH´æ´¢Æ÷ÖÐ¶ÁÊý¾Ýº¯Êý
 194          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 195          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 196          //ÍøÖ·£ºwww.MovingChip.com
 197          //ÈÕÆÚ£º20120916
 198          //---------------------------------------
 199          //¶Á³öÄÚÈÝ·ÅÖÃÓÚBuf[]ÖÐ
 200          void W25X_Flash_Byte_Read (unsigned long Addre24,unsigned char Quantity)  //´ÓFlashÀï¶Á³ö16×Ö½ÚÊý
 201          {
 202   1         unsigned char J;      //¼Æ×Ö½ÚÊý 
 203   1         unsigned char Addre3;
 204   1         unsigned char Addre2;
 205   1         unsigned char Addre1;
 206   1         while(W25X_BUSY_OrNot()==1);  //ÅÐBUSY
 207   1              Addre1=Addre24;
 208   1         Addre24=Addre24>>8;
 209   1         Addre2=Addre24;
 210   1         Addre24=Addre24>>8;
 211   1         Addre3=Addre24;
 212   1         CS=0;
 213   1         Send_OneByte(W25X_ReadDATA8);//ÃüÁî¶Á
 214   1         Send_OneByte(Addre3);
 215   1         Send_OneByte(Addre2);
 216   1         Send_OneByte(Addre1);
 217   1         for (J=0;J<Quantity;J++)
 218   1         {
 219   2              Buf[J]=Read_OneByte();   //¶ÁÒ»¸ö×Ö½Ú
 220   2              }
 221   1         CS=1;
 222   1         _nop_();
 223   1              _nop_();
 224   1         SCLK=1;
 225   1         _nop_();
 226   1              _nop_();
 227   1      }         
 228          //---------------------------------------
 229          //Ãû³Æ: 4KÉÈÇø²Á³ýº¯Êý
 230          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 231          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 232          //ÍøÖ·£ºwww.MovingChip.com
 233          //ÈÕÆÚ£º20120916
 234          //---------------------------------------
 235          void W25X_SectorErase(unsigned char AddreH,unsigned char AddreM,unsigned char AddreL)   //²Á³ý×ÊÁÏÍ¼Ê¾µÄ4KB¿
             -Õ¼ä
 236          {
 237   1         WriteEnable();   //Ð´ÔÊÐí  
 238   1      
 239   1         SCLK=1;
 240   1         CS=0;
C51 COMPILER V7.00  LD788BS                                                                10/16/2012 12:34:50 PAGE 5   

 241   1         Send_OneByte(W25X_S_Erase);//ÕûÉÈ²Á³ýÃüÁî
 242   1         Send_OneByte(AddreH);
 243   1         Send_OneByte(AddreM);
 244   1         Send_OneByte(AddreL);
 245   1         CS=1;
 246   1         _nop_();
 247   1         SCLK=1;
 248   1         _nop_();
 249   1              _nop_();
 250   1      } 
 251          
 252          //---------------------------------------
 253          //Ãû³Æ: ÑÓÊ±º¯Êý
 254          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 255          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 256          //ÍøÖ·£ºwww.MovingChip.com
 257          //ÈÕÆÚ£º20120916
 258          //---------------------------------------
 259          void Delay(unsigned int s) //
 260          {
 261   1         unsigned int loop;
 262   1         for(loop=s;loop>0;loop--)  
 263   1         {        
 264   2            _nop_();
 265   2         }
 266   1      }
 267          //---------------------------------------
 268          //Ãû³Æ: µÈ´ýÉÏÎ»»ú18×Ö½Úº¯Êý
 269          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 270          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 271          //ÍøÖ·£ºwww.MovingChip.com
 272          //ÈÕÆÚ£º20120914
 273          //---------------------------------------
 274          /*bit WaitData()
 275          {
 276                  unsigned char n;
 277                  RI=0;
 278                  for(n=0;n<21;n++)
 279                  {
 280                          nTimeOut=0;
 281                          while(!RI)
 282                          {
 283                                  nTimeOut++;
 284                                  if(nTimeOut>10000)
 285                                  {
 286                                          return 0;
 287                                  }
 288                          }
 289                          RI=0;
 290                          ComBuf[n]=SBUF;
 291                  }
 292                  return 1;
 293          }*/
 294          //---------------------------------------
 295          //Ãû³Æ: ÏòÉÏÎ»»ú·¢ËÍ18×Ö½Úº¯Êý
 296          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 297          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 298          //ÍøÖ·£ºwww.MovingChip.com
 299          //ÈÕÆÚ£º20120914
 300          //---------------------------------------
 301          void SendData()
 302          {
C51 COMPILER V7.00  LD788BS                                                                10/16/2012 12:34:50 PAGE 6   

 303   1              unsigned char s;
 304   1              for(s=0;s<21;s++)
 305   1              {
 306   2                      TI=0;
 307   2                      SBUF=ComBuf[s];
 308   2                      while(!TI){}
 309   2                      TI=0;
 310   2              }
 311   1      }
 312          void zhuan(unsigned char i)            //×î¶àÏÔÊ¾16ºº×Ö£¬0-15
 313          {
 314   1              unsigned char k,g;
 315   1              long Address;
 316   1              unsigned char zc;
 317   1              if(i<8)
 318   1              {
 319   2                      W25X_Flash_Byte_Read(0x1fff00,16);//Á¬Ðø¶Á16¸ö×Ö½Ú£¬·ÅÈëBUF[]Àï 
 320   2                      Address=neima(Buf[i*2],Buf[i*2+1]);
 321   2              }
 322   1              else if(i<16)
 323   1              {
 324   2                      W25X_Flash_Byte_Read(0x1fff10,16);//Á¬Ðø¶Á16¸ö×Ö½Ú£¬·ÅÈëBUF[]Àï 
 325   2                      Address=neima(Buf[(i-8)*2],Buf[(i-8)*2+1]);
 326   2              }               
 327   1              else if(i<24)
 328   1              {
 329   2                      W25X_Flash_Byte_Read(0x1fff20,16);//Á¬Ðø¶Á16¸ö×Ö½Ú£¬·ÅÈëBUF[]Àï 
 330   2                      Address=neima(Buf[(i-16)*2],Buf[(i-16)*2+1]);
 331   2              }
 332   1              else
 333   1              {
 334   2                      W25X_Flash_Byte_Read(0x1fff30,16);//Á¬Ðø¶Á16¸ö×Ö½Ú£¬·ÅÈëBUF[]Àï 
 335   2                      Address=neima(Buf[(i-24)*2],Buf[(i-24)*2+1]);
 336   2              }
 337   1              //W25X_Flash_Byte_Read(0x1fff00+(i/8)&0x10,16);//Á¬Ðø¶Á16¸ö×Ö½Ú£¬·ÅÈëBUF[]Àï    
 338   1              //Address=neima(Buf[(i%8)*2],Buf[(i%8)*2+1]);
 339   1      
 340   1              W25X_Flash_Byte_Read(Address,16);//Á¬Ðø¶Á16¸ö×Ö½Ú£¬·ÅÈëBUF[]Àï
 341   1              for(g=0;g<8;g++)  //bit7-bit0
 342   1              {
 343   2                      zc=0;
 344   2                      for(k=0;k<8;k++)
 345   2                      {
 346   3                              zc=zc<<1;
 347   3                              if(Buf[k*2]&0x80) zc|=0x01;
 348   3                              Buf[k*2]=Buf[k*2]<<1;                           
 349   3                      }
 350   2                      hanzibuf1[i*16+g]=zc;
 351   2              }
 352   1              for(g=0;g<8;g++)  //bit7-bit0
 353   1              {
 354   2                      zc=0;
 355   2                      for(k=0;k<8;k++)
 356   2                      {
 357   3                              zc=zc<<1;
 358   3                              if(Buf[k*2+1]&0x80) zc|=0x01;
 359   3                              Buf[k*2+1]=Buf[k*2+1]<<1;
 360   3                      }
 361   2                      hanzibuf1[i*16+8+g]=zc;
 362   2              }
 363   1              W25X_Flash_Byte_Read(Address+16,16);//Á¬Ðø¶Á16¸ö×Ö½Ú£¬·ÅÈëBUF[]Àï
 364   1              for(g=0;g<8;g++)  //bit7-bit0
C51 COMPILER V7.00  LD788BS                                                                10/16/2012 12:34:50 PAGE 7   

 365   1              {
 366   2                      zc=0;
 367   2                      for(k=0;k<8;k++)
 368   2                      {
 369   3                              zc=zc<<1;
 370   3                              if(Buf[k*2]&0x80) zc|=0x01;
 371   3                              Buf[k*2]=Buf[k*2]<<1;                           
 372   3                      }
 373   2                      hanzibuf2[i*16+g]=zc;
 374   2              }
 375   1              for(g=0;g<8;g++)  //bit7-bit0
 376   1              {
 377   2                      zc=0;
 378   2                      for(k=0;k<8;k++)
 379   2                      {
 380   3                              zc=zc<<1;
 381   3                              if(Buf[k*2+1]&0x80) zc|=0x01;
 382   3                              Buf[k*2+1]=Buf[k*2+1]<<1;
 383   3                      }
 384   2                      hanzibuf2[i*16+8+g]=zc;
 385   2              }
 386   1      }
 387          //---------------------------------------
 388          //Ãû³Æ£º´®¿ÚÖÐ¶Ï·þÎñ³ÌÐò
 389          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 390          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 391          //ÍøÖ·£ºwww.MovingChip.com
 392          //ÈÕÆÚ£º20120914
 393          //---------------------------------------
 394          void UART_SER (void) interrupt 4 
 395          {
 396   1              if(RI==1)              //Èç¹û½ÓÊÕ±êÖ¾Î»Îª1£¬ËµÃ÷ÓÐÊý¾Ý½ÓÊÕÍê±Ï
 397   1         {                      //RCIFÔÚ¼Ä´æÆ÷±»¶Á³öºó×Ô¶¯ÇåÁã
 398   2            ComBuf[0]=SBUF;     //½«½ÓÊÕ»º³åÇøÄÚÈÝ×ªÖÁUSARTbuf¼Ä´æÆ÷ÖÐ
 399   2            RI=0;               //Çå³ý½ÓÊÕ±êÖ¾Î»   
 400   2                      EA=0;
 401   2         }
 402   1         for(n=1;n<21;n++)
 403   1         {
 404   2                      nTimeOut=0;
 405   2                      while(!RI)
 406   2                      {
 407   3                              nTimeOut++;
 408   3                              if(nTimeOut>10000)
 409   3                              {
 410   4                                      while(1);
 411   4                              }
 412   3                      }
 413   2                      RI=0;
 414   2                      ComBuf[n]=SBUF;
 415   2              }
 416   1              if(ComBuf[0]==1)        //Èç¹ûÉÏÎ»»ú·¢1£¬Îª¶ÁÊ¶±ðÂë
 417   1              {
 418   2                      ComBuf[2]=6;
 419   2              ComBuf[3]=2;
 420   2              ComBuf[4]=4;  
 421   2                      SendData();     //½«Ê¶±ðÂë624·¢¸øÉÏÎ»»ú
 422   2                      while(1);
 423   2              }
 424   1              else if(ComBuf[0]==2) //Èç¹ûÉÏÎ»»ú·¢2£¬ÎªÐ´W25Q16
 425   1              {
 426   2                      W25X_SectorErase(0x1F,0xFF,0);                          
C51 COMPILER V7.00  LD788BS                                                                10/16/2012 12:34:50 PAGE 8   

 427   2                      Delay(10000); //
 428   2                      SendData();//»ØÓ¦ÉÏÎ»»ú±íÊ¾½øÈëÐ´Æ÷¼þ×´Ì¬£¬¿ÉÒÔ·¢À´Êý¾Ý         
 429   2                      while(1)
 430   2                      {
 431   3                              for(n=0;n<21;n++)
 432   3                      {
 433   4                                      nTimeOut=0;
 434   4                                      while(!RI)
 435   4                                      {
 436   5                                              nTimeOut++;
 437   5                                              if(nTimeOut>10000)
 438   5                                              {
 439   6                                                      while(1);
 440   6                                              }
 441   5                                      }
 442   4                                      RI=0;
 443   4                                      ComBuf[n]=SBUF;
 444   4                              }
 445   3                              if(ComBuf[1]==0x01)//Èç¹û½ÓÊÕÊý¾Ý³É¹¦²¢ÇÒComBuf[0]==1±íÊ¾¼ÌÐøÐ´
 446   3                              {                                               
 447   4                                      for(n=0;n<16;n++)
 448   4                                      {
 449   5                                              Buf[n]=ComBuf[n+2];  //°Ñ½ÓÊÕµ½µÄCOMBUF[2]-[17]ÄÚµÄÊý¾ÝÒÆµ½
 450   5                                              //BUF[0]-[15]ÄÚ£¬ÒÔ±ãÌ×ÓÃÁ¬ÐøÐ´º¯Êý¸ñÊ½
 451   5                                      }               
 452   4                                      W25X_Flash_Byte_Write(ComBuf[18],ComBuf[19],ComBuf[20]);//ComBuf[2~17]Îª´ýÐ´ÈëÊý¾Ý¿é
 453   4                                      SendData();                                     //Í¨ÖªÉÏÎ»»ú¼ÌÐø·¢                      
 454   4                              }       
 455   3                              else
 456   3                              {
 457   4                                      while(1);
 458   4                              }
 459   3                      }               
 460   2              }                       
 461   1              while(1);
 462   1      }
 463          //---------------------------------------
 464          //Ãû³Æ: Ö÷º¯Êý
 465          //ÊÊÓÃ£º¸øÁ¦ÕßGL9µ¥Æ¬»ú¿ª·¢Ñ§Ï°ÏµÍ³
 466          //¹«Ë¾£ºÄþ²¨Ð¾¶¯µç×ÓÓÐÏÞ¹«Ë¾
 467          //ÍøÖ·£ºwww.MovingChip.com
 468          //ÈÕÆÚ£º20120914
 469          //---------------------------------------
 470          void main(void)            //Ö÷º¯Êý,µ¥Æ¬»ú¿ª»úºó¾ÍÊÇ´ÓÕâ¸öº¯Êý¿ªÊ¼ÔËÐÐ
 471          {
 472   1              
 473   1          //*****USART´®¿Ú³õÊ¼»¯*****
 474   1              TMOD&=0x0F;            //°ÑTMOD¸ß4Î»Çå0
 475   1              TMOD|=0x20;            //½«TMODµÄM1Î»ÖÃ1£¬ÉèÖÃ³É×Ô¶¯×°ÈëµÄ8Î»¶¨Ê±Æ÷
 476   1         TH1=0xFF;              //ÉèÖÃ²¨ÌØÂÊÎª57600
 477   1         TL1=0xFF;              //ÉèÖÃ²¨ÌØÂÊÎª57600
 478   1         TR1=1;                 //Æô¶¯¶¨Ê±Æ÷T1£¬×÷Îª´®¿Ú²¨ÌØÂÊ·¢ÉúÆ÷
 479   1         SCON=0x50;             //10Î»Òì²½ÊÕ·¢£¬²¨ÌØÂÊÓÉ¶¨Ê±Æ÷¿ØÖÆ£¬ÔÊÐí´®¿Ú½ÓÊÕ
 480   1              ES=1;                  //ÔÊÐí´®¿ÚÖÐ¶Ï
 481   1         //************************** 
 482   1              W25X_Flash_Byte_Read(0x1ffff0,16);//Á¬Ðø¶Á16¸ö×Ö½Ú£¬·ÅÈëBUF[]Àï
 483   1              L=Buf[12];
 484   1              for(nTimeOut=0;nTimeOut<512;nTimeOut++) hanzibuf1[nTimeOut]=0;
 485   1              for(nTimeOut=0;nTimeOut<512;nTimeOut++) hanzibuf2[nTimeOut]=0;
 486   1              for(n=0;n<L;n++) zhuan(n);                              
 487   1              
 488   1              WDT_CONTR=0x3e;
C51 COMPILER V7.00  LD788BS                                                                10/16/2012 12:34:50 PAGE 9   

 489   1              //12Ê±ÖÓÄ£Ê½£¬¿´ÃÅ¹·Òç³öÊ±¼ä=£¨12*Pre_scale*32768£©/12000000
 490   1              //=     Pre_scale*393216/12000000
 491   1              //ÉèÖÃÎª128·ÖÆµ£¬¿´ÃÅ¹·Òç³öÊ±¼äÎª2.1Ãë
 492   1      
 493   1              //***¿ªÈ«¾ÖÖÐ¶ÏÉèÖÃ****
 494   1          //´®¿Ú½Ó¿ÚUARTÉèÖÃÁËÖÐ¶ÏÔÊÐí,´Ë´¦Òª¿ªÈ«¾ÖÖÐ¶Ï
 495   1          EA=1;                  //¿ªÈ«¾ÖÖÐ¶Ï
 496   1          //*********************
 497   1              while(1)                //ËÀÑ­»·,µ¥Æ¬»ú³õÊ¼»¯ºó,½«Ò»Ö±ÔËÐÐÕâ¸öËÀÑ­»·
 498   1          {    
 499   2                      WDT_CONTR=0x3e;
 500   2                      for(n=0;n<100;n++);     //×öÒ»¸ö0-80µÄÑ­»·£¬²»Ö´ÐÐÆäËû²Ù×÷£¬Ö»ÎªÑÓÊ±
 501   2                 if(++w>250)          //ÔÙÇ¶Ì×Ò»¸öÑÓÊ±£¬Ã¿220¸öÉ¨ÃèÖÜÆÚ½«ºº×Ö×óÒÆÒ»¸ñ
 502   2            {
 503   3               w=0;                   //ÇåÁã£¬ÒÔ×¼±¸ÏÂÒ»¸öÑÓÊ±
 504   3               if(++v>(L*16-1)) v=0;;                                 //ÒÆ¶¯Ë÷Òý£¬ÏÞ¶¨ÔÚ0-191
 505   3            }
 506   2            if(++m>15) m=0;           //Ã¿µ÷ÓÃÒ»´Îº¯Êý½«m¼Ó1£¬²¢ÏÞÖÆÔÚ0-15ÒÔÄÚ
 507   2            P1=0;                     //½«LEDµãÕóÆÁµÄÁÐ¿ØÖÆÐÅºÅÈ«²¿ÇåÁã£¬×¼±¸ÖØÖÃ  
 508   2                      if(m+v>511)
 509   2                      {
 510   3                              P0=0;           
 511   3                              P2=0;             
 512   3                      }
 513   2                      else
 514   2                      {
 515   3                              P0=hanzibuf1[m+v];              
 516   3                              P2=hanzibuf2[m+v]; //LEDµãÕóÆÁµÄÏÂ°ëÆÁ£¬°´m+16Ë÷Òý²é±íËÍP2 
 517   3                      }
 518   2            P1|=m&0x07;               //½«Ë÷ÒýmµÄµÍ3Î»ËÍ¸øP1µÄµÍ3Î»£¬ÒÔÊ¹74HC138È¥Æ¬Ñ¡ 
 519   2            if(m<8) U15E3=1;          //Ç°8ÁÐÐèÒªÊ¹ÄÜU15(74HC138) 
 520   2            else U14E3=1;             //ºó8ÁÐÐèÒªÊ¹ÄÜU14(74HC138)     
 521   2         }
 522   1      }
 523          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1365    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   1024    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     45      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
