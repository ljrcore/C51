C51 COMPILER V7.00  TEST71                                                                 07/02/2013 19:25:49 PAGE 1   


C51 COMPILER V7.00, COMPILATION OF MODULE TEST71
OBJECT MODULE PLACED IN TEST71.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE TEST71.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          ////////////////////////////////////////////////////////////////////////////
   2          //                给力者单片机开发学习系统，开发学习都给力！              //
   3          ////////////////////////////////////////////////////////////////////////////
   4          //                     学习51单片机，其实可以很简单                       //
   5          ////////////////////////////////////////////////////////////////////////////
   6          //                宁波芯动电子有限公司  www.MovingChip.com                //
   7          ////////////////////////////////////////////////////////////////////////////
   8          
   9          #include <AT89X52.h>       //调用51单片机的头文件
  10          #include <Intrins.h> 
  11          //---------------------------------------
  12          //1602液晶相关I/O设置
  13          sbit E=P2^3;               //1602液晶的E脚接在P2.3口上
  14          sbit RW=P2^4;              //1602液晶的RW脚接在P2.4口上
  15          sbit RS=P2^5;              //1602液晶的RS脚接在P2.5口上
  16          //---------------------------------------
  17          unsigned int  Timeout;
  18          unsigned char RH_H;
  19          unsigned char RH_L;
  20          unsigned char T_H;
  21          unsigned char T_L;
  22          unsigned char Checkdata;
  23          //---------------------------------------
  24          //名称：延时函数
  25          //适用：给力者GL9单片机开发学习系统
  26          //公司：宁波芯动电子有限公司
  27          //网址：www.MovingChip.com
  28          //日期：20130702
  29          //---------------------------------------
  30          void Delay(unsigned int j) 
  31          { 
  32   1              unsigned char i;
  33   1         for(;j>0;j--)
  34   1              {       
  35   2                      for(i=0;i<54;i++);
  36   2              }
  37   1      }
  38          
  39          //---------------------------------------
  40          //名称：1602液晶忙检测函数
  41          //适用：给力者GL9单片机开发学习系统
  42          //公司：宁波芯动电子有限公司
  43          //网址：www.MovingChip.com
  44          //日期：20130702
  45          //---------------------------------------
  46          void LCD1602_busy(void)
  47          { 
  48   1           P0_7=1;              //将P0.7置1，为读状态做准备 
  49   1           RS=0;                //RS=0、RW=1、E=1时，忙信号输出到DB7，由P0.7读入
  50   1           RW=1;                //RS=0、RW=1、E=1时，忙信号输出到DB7，由P0.7读入
  51   1           E=1;                 //RS=0、RW=1、E=1时，忙信号输出到DB7，由P0.7读入
  52   1           while(P0_7==1);      //由P0.7读入1，表示1602液晶忙，需要等待
  53   1           E=0;                 //读完以后，恢复E的电平
  54   1      } 
  55          
C51 COMPILER V7.00  TEST71                                                                 07/02/2013 19:25:49 PAGE 2   

  56          //---------------------------------------
  57          //名称：1600写命令函数
  58          //适用：给力者GL9单片机开发学习系统
  59          //公司：宁波芯动电子有限公司
  60          //网址：www.MovingChip.com
  61          //日期：20130702
  62          //---------------------------------------
  63          void LCD1602_Write_com(unsigned char combuf)
  64          { 
  65   1           RS=0;                //选择指令寄存器
  66   1           RW=0;                //选择写状态
  67   1           P0=combuf;           //将命令字通过P0口送至DB
  68   1           E=1;                 //E高电平将命令字写入1602液晶
  69   1           E=0;                 //写完以后，恢复E的电平
  70   1      } 
  71          
  72          //---------------------------------------
  73          //名称：1602写命令函数(带忙检测)
  74          //适用：给力者GL9单片机开发学习系统
  75          //公司：宁波芯动电子有限公司
  76          //网址：www.MovingChip.com
  77          //日期：20130702
  78          //---------------------------------------
  79          void LCD1602_Write_com_busy(unsigned char combuf)
  80          { 
  81   1           LCD1602_busy();            //调用忙检测函数
  82   1           LCD1602_Write_com(combuf); //调用忙检测函数
  83   1      } 
  84          
  85          //---------------------------------------
  86          //名称：1602写数据函数(带忙检测)
  87          //适用：给力者GL9单片机开发学习系统
  88          //公司：宁波芯动电子有限公司
  89          //网址：www.MovingChip.com
  90          //日期：20130702
  91          //---------------------------------------
  92          void LCD1602_Write_data_busy(unsigned char databuf)
  93          { 
  94   1           LCD1602_busy();      //调用忙检测函数
  95   1           RS=1;                //选择数据寄存器
  96   1           RW=0;                //选择写状态
  97   1           P0=databuf;          //将命令字通过P0口送至DB
  98   1           E=1;                 //E高电平将命令字写入1602液晶
  99   1           E=0;                 //写完以后，恢复E的电平
 100   1      } 
 101          
 102          //---------------------------------------
 103          //名称：1602液晶显示地址写函数
 104          //适用：给力者GL9单片机开发学习系统
 105          //公司：宁波芯动电子有限公司
 106          //网址：www.MovingChip.com
 107          //日期：20130702
 108          //---------------------------------------
 109          void LCD1602_Write_address(unsigned char x,unsigned char y)
 110          { 
 111   1           x&=0x0f;             //列地址限制在0-15间
 112   1           y&=0x01;             //行地址限制在0-1间
 113   1           if(y==0)             //如果是第一行
 114   1               LCD1602_Write_com_busy(x|0x80);        //将列地址写入
 115   1           else                 //如果是第二行
 116   1               LCD1602_Write_com_busy((x+0x40)|0x80); //将列地址写入
 117   1      } 
C51 COMPILER V7.00  TEST71                                                                 07/02/2013 19:25:49 PAGE 3   

 118          
 119          //---------------------------------------
 120          //名称：1602液晶初始化函数
 121          //适用：给力者GL9单片机开发学习系统
 122          //公司：宁波芯动电子有限公司
 123          //网址：www.MovingChip.com
 124          //日期：20130702
 125          //---------------------------------------
 126          void LCD1602_init(void)
 127          { 
 128   1           Delay(150);               //调用延时函数
 129   1           LCD1602_Write_com(0x38);       //8位数据总线，两行显示模式，5*7点阵显示
 130   1           Delay(50);                //调用延时函数
 131   1           LCD1602_Write_com(0x38);       //8位数据总线，两行显示模式，5*7点阵显示
 132   1           Delay(50);                //调用延时函数
 133   1           LCD1602_Write_com(0x38);       //8位数据总线，两行显示模式，5*7点阵显示
 134   1           LCD1602_Write_com_busy(0x38);  //8位数据总线，两行显示模式，5*7点阵显示
 135   1           LCD1602_Write_com_busy(0x08);  //显示功能关，无光标
 136   1           LCD1602_Write_com_busy(0x01);  //清屏
 137   1           LCD1602_Write_com_busy(0x06);  //写入新的数据后，光标右移，显示屏不移动
 138   1           LCD1602_Write_com_busy(0x0C);  //显示功能开，无光标
 139   1      } 
 140          
 141          //---------------------------------------
 142          //名称：1602液晶指定地址显示函数
 143          //适用：给力者GL9单片机开发学习系统
 144          //公司：宁波芯动电子有限公司
 145          //网址：www.MovingChip.com
 146          //日期：20130702
 147          //---------------------------------------
 148          void LCD1602_Disp(unsigned char x,unsigned char y,unsigned char buf)
 149          { 
 150   1           LCD1602_Write_address(x,y);    //先将地址信息写入
 151   1           LCD1602_Write_data_busy(buf);  //再写入要显示的数据
 152   1      } 
 153          //---------------------------------------
 154          //名称：单总线读字节函数
 155          //适用：给力者GL9单片机开发学习系统
 156          //公司：宁波芯动电子有限公司
 157          //网址：www.MovingChip.com
 158          //日期：20130702
 159          //---------------------------------------
 160          unsigned char   Read1Byte(void)
 161          {     
 162   1              unsigned char i;
 163   1              unsigned char buf=0;
 164   1              for(i=0;i<8;i++)           //每次读1位数据，共需8次才能读完一个字节
 165   1              {       
 166   2                      P3_6=1;           //读数据前，先把口线置1，做好读的准备
 167   2                 Timeout=0;        //超时计数清零
 168   2                      while((P3_6==0)&&((Timeout++)<500));  //P3_6读为1，或者超时了都退出循环
 169   2                      TH0=0xff;                       //26-28US后读入一个位，此处为了可靠，延时30微秒
 170   2                      TL0=0xc8;                       //26-28US后读入一个位，此处为了可靠，延时30微秒
 171   2                      TF0=0;                          //26-28US后读入一个位，此处为了可靠，延时30微秒 
 172   2                      while(!TF0);            //26-28US后读入一个位，此处为了可靠，延时30微秒   
 173   2                      buf<<=1;          //buf左移一位，因为数据是从最高位先入的
 174   2                 if(P3_6==1) buf|=0x01;//如果读进的数据为1，那么把1写在BUF的最低位
 175   2                      Timeout=0;        //超时计数清零
 176   2                      while((P3_6==1)&&((Timeout++)<500)); //P3_6读为0，或者超时了都退出循环          
 177   2              } 
 178   1              return buf;          //读8次后，8位数据保存在BUF中，将BUF作为输出参数返回
 179   1      }
C51 COMPILER V7.00  TEST71                                                                 07/02/2013 19:25:49 PAGE 4   

 180          //---------------------------------------
 181          //名称：握手协议和湿度读取函数
 182          //适用：给力者GL9单片机开发学习系统
 183          //公司：宁波芯动电子有限公司
 184          //网址：www.MovingChip.com
 185          //日期：20130702
 186          //---------------------------------------
 187          //----湿度整数== RH_H-----
 188          //----湿度小数== RH_L-----
 189          //----温度整数== T_H------
 190          //----温度小数== T_L------
 191          //----校验8位 == Checkdata-----
 192          unsigned char ReadRH(void)
 193          {       
 194   1         P3_6=0;                                      //总线拉低
 195   1              TH0=0x77;                               //延时19毫秒
 196   1              TL0=0x33;                               //延时19毫秒
 197   1              TF0=0;                                  //延时19毫秒
 198   1              while(!TF0);                    //延时19毫秒
 199   1              P3_6=1;              //总线拉高
 200   1              TH0=0xff;            //延时50微秒
 201   1              TL0=0xa3;            //延时50微秒
 202   1              TF0=0;              //延时50微秒        
 203   1              while(!TF0);         //延时50微秒 
 204   1              if(P3_6==0)                             //50微秒后读总线电平，低电平则收到DHT11的回复信号 
 205   1              {
 206   2                      Timeout=0;
 207   2                      while((P3_6==0)&&((Timeout++)<500)); //等待上升沿，超时退出
 208   2                      Timeout=0;
 209   2                      while((P3_6==1)&&((Timeout++)<500)); //等待下降沿，超时退出 
 210   2                 RH_H=Read1Byte();            //读第一个字节，内容为湿度参数整数部分   
 211   2                 RH_L=Read1Byte();            //读第二个字节，内容为湿度参数小数部分     
 212   2                 T_H=Read1Byte();             //读第三个字节，内容为温度参数整数部分     
 213   2                 T_L=Read1Byte();             //读第四个字节，内容为温度参数小数部分    
 214   2                 Checkdata=Read1Byte();  //读第五个字节，内容为前四个字节的校验码
 215   2                 if(Checkdata==RH_H + RH_L + T_H + T_L)       //如果校验码等于其他4个字节的和
 216   2                              return 1;                       //校验成功，返回1
 217   2                      else
 218   2                              return 0;                       //校验失败，返回0
 219   2              }
 220   1              else
 221   1                      return 0;                               //50微秒后读总线电平，高电平则没收到DHT11的回复信号，返回0
 222   1      }
 223          //---------------------------------------
 224          //名称: 主函数
 225          //适用：给力者GL9单片机开发学习系统
 226          //公司：宁波芯动电子有限公司
 227          //网址：www.MovingChip.com
 228          //日期：20130702
 229          //---------------------------------------
 230          void main(void)            //主函数,单片机开机后就是从这个函数开始运行
 231          {
 232   1              //***定时器Timer0初始化***
 233   1              TMOD&=0xF0;            //将TMOD的低4位定时器0控制部分清零
 234   1         TMOD|=0x01;            //设置定时器0为方式1    
 235   1         TR0=1;                 //启动定时器0
 236   1         ET0=0;                 //Timer0中断禁止
 237   1          //**********************
 238   1         LCD1602_init();        //调用1602液晶初始化函数
 239   1              while(1)
 240   1              {
 241   2                      if(ReadRH()==1)     //调用读湿度函数，如果返回1，标志着读成功
C51 COMPILER V7.00  TEST71                                                                 07/02/2013 19:25:49 PAGE 5   

 242   2                      {
 243   3                              LCD1602_Disp(0,0,'R');   //显示R
 244   3                              LCD1602_Disp(1,0,'H');   //显示H
 245   3                      LCD1602_Disp(2,0,':');   //显示:                
 246   3                              LCD1602_Disp(3,0,RH_H/10+'0');  //温度整数部分十位      
 247   3                              LCD1602_Disp(4,0,RH_H%10+'0');  //温度整数部分个位
 248   3                              LCD1602_Disp(5,0,'%');   //显示%                
 249   3      
 250   3                              LCD1602_Disp(0,1,'T');   //显示T
 251   3                      LCD1602_Disp(1,1,':');   //显示:        
 252   3                              LCD1602_Disp(2,1,T_H/10+'0');  //温度整数部分十位               
 253   3                              LCD1602_Disp(3,1,T_H%10+'0');  //温度整数部分个位
 254   3                              LCD1602_Disp(4,1,0xdf);   //显示.
 255   3                              LCD1602_Disp(5,1,0x43);   //显示C               
 256   3                 }
 257   2              }
 258   1      }
 259          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    541    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
